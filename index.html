<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ - Ultra Fix</title>
    <style>
        :root { --bg: #050505; --accent: #f1c40f; --card: #121212; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 400px; height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        /* ÙƒØ§Ù…ÙŠØ±Ø§ Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ© */
        .cam-box { position: relative; width: 100%; height: 42%; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .side-mask { position: absolute; top:0; bottom:0; width: 20%; background: rgba(0,0,0,0.8); z-index: 5; }
        .m-left { left: 0; } .m-right { right: 0; }
        .aim { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); width: 60px; height: 60px; border: 3px solid var(--accent); border-radius: 12px; z-index: 10; }
        .bar { position: absolute; bottom: -10px; left: 0; width: 0%; height: 4px; background: white; transition: 0.1s; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        #quiz { flex: 1; padding: 20px; background: var(--card); border-top: 1px solid #333; }
        .info { display: flex; justify-content: space-between; color: var(--accent); font-weight: bold; margin-bottom: 15px; }
        .q-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 25px; line-height: 1.5; }
        
        .opt { background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; border: 2px solid transparent; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-left: 12px; }
        .g { background: #00ff00; } .y { background: #ffff00; } .r { background: #ff0000; }
        .active { border-color: white !important; background: #222 !important; }
        .res { margin-right: auto; font-weight: bold; }

        #start-btn { background: var(--accent); padding: 15px 40px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; }
        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color:var(--accent)">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ</h1>
    <button id="start-btn" onclick="start()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
</div>

<div id="app">
    <div class="cam-box">
        <video id="v" autoplay playsinline></video>
        <div class="side-mask m-left"></div>
        <div class="side-mask m-right"></div>
        <div class="aim"><div id="p-bar" class="bar"></div></div>
    </div>
    <div id="quiz">
        <div class="info">
            <span id="stat-q">Ø§Ù„Ø³Ø¤Ø§Ù„: 1 / 45</span>
            <span id="stat-s">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</span>
        </div>
        <div id="txt-q" class="q-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div id="opts">
            <div class="opt" id="o-green"><div class="dot g"></div><span id="t-g"></span><span class="res" id="r-g"></span></div>
            <div class="opt" id="o-yellow"><div class="dot y"></div><span id="t-y"></span><span class="res" id="r-y"></span></div>
            <div class="opt" id="o-red"><div class="dot r"></div><span id="t-r"></span><span class="res" id="r-r"></span></div>
        </div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const bank = [
    {q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", g:"Ø®Ù…Ø³Ø©", y:"Ø³ØªØ©", r:"Ø£Ø±Ø¨Ø¹Ø©", c:"green"},
    {q:"Ù…Ù† Ù‡Ùˆ Ø®Ø§ØªÙ… Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ØŸ", g:"Ø¹ÙŠØ³Ù‰", y:"Ù…Ø­Ù…Ø¯ ï·º", r:"Ù…ÙˆØ³Ù‰", c:"yellow"},
    {q:"Ù…Ø§ Ù‡ÙŠ Ø£Ø·ÙˆÙ„ Ø³ÙˆØ±Ø©ØŸ", g:"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", y:"Ø§Ù„Ø¨Ù‚Ø±Ø©", r:"Ø§Ù„Ù†Ø³Ø§Ø¡", c:"yellow"},
    {q:"Ø£ÙŠÙ† ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙŠ ï·ºØŸ", g:"Ù…ÙƒØ©", y:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", r:"Ø§Ù„Ø·Ø§Ø¦Ù", c:"green"},
    {q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", g:"20", y:"30", r:"60", c:"yellow"}
];

// ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ø¶Ù…Ø§Ù† 45 Ø³Ø¤Ø§Ù„
let questions = [];
while(questions.length < 45) questions.push(...bank);
questions = questions.sort(() => Math.random() - 0.5).slice(0, 45);

let cur = 0, score = 0, locked = false, timer = 0, lastCol = null;
const v = document.getElementById('v'), pBar = document.getElementById('p-bar');

async function start() {
    document.getElementById('overlay').style.display = 'none';
    const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    v.srcObject = s;
    updateQ();
    loop();
}

function updateQ() {
    if(cur >= 45) {
        document.getElementById('quiz').innerHTML = `<h2 style="text-align:center">Ø§Ù†ØªÙ‡Ù‰!<br>Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}</h2>`;
        return;
    }
    const q = questions[cur];
    document.getElementById('txt-q').innerText = q.q;
    document.getElementById('t-g').innerText = q.g;
    document.getElementById('t-y').innerText = q.y;
    document.getElementById('t-r').innerText = q.r;
    document.getElementById('stat-q').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${cur + 1} / 45`;
    
    // ØªØµÙÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ…Ø§Ù…Ø§Ù‹
    document.querySelectorAll('.res').forEach(e => e.innerText = "");
    document.querySelectorAll('.opt').forEach(e => e.classList.remove('active'));
    timer = 0; pBar.style.width = "0%";
    locked = false; 
}

function loop() {
    if(!locked && v.readyState === v.HAVE_ENOUGH_DATA) {
        const c = document.getElementById('canvas');
        const ctx = c.getContext('2d');
        c.width = 40; c.height = 40;
        ctx.drawImage(v, v.videoWidth/2-20, v.videoHeight/2-20, 40, 40, 0, 0, 40, 40);
        const color = detect(ctx.getImageData(0,0,40,40).data);
        
        if(color) {
            if(color === lastCol) {
                timer += 5;
                pBar.style.width = timer + "%";
                document.querySelectorAll('.opt').forEach(e => e.classList.remove('active'));
                document.getElementById('o-'+color).classList.add('active');
                if(timer >= 100) handle(color);
            } else { lastCol = color; timer = 0; }
        } else { timer = 0; lastCol = null; pBar.style.width = "0%"; }
    }
    requestAnimationFrame(loop);
}

function detect(d) {
    let r=0, g=0, b=0;
    for(let i=0; i<d.length; i+=4) { r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
    r/=1600; g/=1600; b/=1600;
    if (g > r * 1.3 && g > b * 1.3) return "green";
    if (r > 100 && g > 100 && Math.abs(r-g) < 40 && (r+g) > b*2) return "yellow";
    if (r > g * 1.5 && r > b * 1.5) return "red";
    return null;
}

function handle(col) {
    locked = true; // Ù‚ÙÙ„ ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø­Ø±Ùƒ
    const correct = questions[cur].c;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£Ù…Ø§Ù… ÙƒÙ„ Ø®ÙŠØ§Ø±
    if(col === correct) {
        document.getElementById('r-'+col).innerText = "âœ…";
        score++;
        document.getElementById('stat-s').innerText = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
    } else {
        document.getElementById('r-'+col).innerText = "âŒ";
        document.getElementById('r-'+correct).innerText = "ğŸ‘ˆ";
    }

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆÙ†ØµÙ
    setTimeout(() => {
        cur++;
        updateQ();
    }, 1500);
}
</script>
</body>
</html>