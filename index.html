<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-wrapper {
            position: relative;
            width: 100%;
            height: 40%;
            background: #000;
            border-bottom: 1px solid #333;
        }
        
        video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.5;
        }

        .scanner-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            border: 2px solid #fff;
            border-radius: 8px;
            z-index: 10;
            box-shadow: 0 0 0 100vh rgba(0, 0, 0, 0.8);
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        #question-area {
            flex: 1;
            padding: 20px;
            background: #111;
            display: flex;
            flex-direction: column;
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            color: #f1c40f;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            background: #222;
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            border: 1px solid #333;
            transition: 0.3s;
        }

        .color-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .dot-green { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .dot-yellow { background: #ffff00; box-shadow: 0 0 8px #ffff00; }
        .dot-red { background: #ff0000; box-shadow: 0 0 8px #ff0000; }

        .option.selected { border-color: #fff; background: #333; }

        .res-icon { margin-right: auto; font-weight: bold; }

        #start-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background:#000; z-index:100; display:flex; 
            flex-direction:column; justify-content:center; align-items:center;
            text-align: center;
        }

        #start-btn {
            background:#f1c40f; color:#000; border:none;
            padding:12px 40px; border-radius:30px; font-weight:bold; cursor:pointer;
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:#f1c40f">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰</h1>
        <p style="padding:20px; color:#aaa">Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± 45 Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹.<br>Ø£Ø¬Ø¨ Ø¨Ø±ÙØ¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø±Ø¨Ø¹.</p>
        <button id="start-btn" onclick="initGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
    </div>

    <div id="game-container" style="display:none">
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-box"></div>
        </div>

        <div id="question-area">
            <div class="q-header">
                <span id="q-counter">Ø³Ø¤Ø§Ù„: 1 / 45</span>
                <span id="score-display">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</span>
            </div>
            <div class="question-text" id="q-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            
            <div class="options">
                <div class="option" id="card-green">
                    <div class="color-dot dot-green"></div>
                    <span id="text-green"></span>
                    <span class="res-icon" id="res-green"></span>
                </div>
                <div class="option" id="card-yellow">
                    <div class="color-dot dot-yellow"></div>
                    <span id="text-yellow"></span>
                    <span class="res-icon" id="res-yellow"></span>
                </div>
                <div class="option" id="card-red">
                    <div class="color-dot dot-red"></div>
                    <span id="text-red"></span>
                    <span class="res-icon" id="res-red"></span>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¶Ø®Ù… (Ø£Ø¶Ù Ù…Ø§ Ø´Ø¦Øª Ù‡Ù†Ø§) ---
        const masterBank = [
            { q: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ³Ù…Ù‰ Ø¹Ø±ÙˆØ³ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", g: "ÙŠØ³", y: "Ø§Ù„Ø±Ø­Ù…Ù†", r: "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", c: "yellow" },
            { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", g: "114", y: "110", r: "120", c: "green" },
            { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù†Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ø§Ø¨ØªÙ„Ø¹Ù‡ Ø§Ù„Ø­ÙˆØªØŸ", g: "ÙŠÙˆØ³Ù", y: "ÙŠÙˆÙ†Ø³", r: "Ø£ÙŠÙˆØ¨", c: "yellow" },
            { q: "Ø£ÙŠÙ† ÙˆÙ„Ø¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø´Ø§ÙØ¹ÙŠØŸ", g: "Ù…ÙƒØ©", y: "Ø¨ØºØ¯Ø§Ø¯", r: "ØºØ²Ø©", c: "red" },
            { q: "Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨ Ø­Ù…Ø²Ø© Ø¨Ù† Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø·Ù„Ø¨ØŸ", g: "Ø§Ù„ÙØ§Ø±ÙˆÙ‚", y: "Ø£Ø³Ø¯ Ø§Ù„Ù„Ù‡", r: "Ø°Ùˆ Ø§Ù„Ù†ÙˆØ±ÙŠÙ†", c: "yellow" },
            { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", g: "15", y: "10", r: "20", c: "green" },
            { q: "Ù…Ø§ Ù‡ÙŠ Ø£Ø·ÙˆÙ„ Ø¢ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", g: "Ø§Ù„ÙƒØ±Ø³ÙŠ", y: "Ø§Ù„Ø¯ÙŠÙ†", r: "Ø§Ù„Ù†ÙˆØ±", c: "yellow" },
            { q: "Ù…Ù† Ù‡ÙŠ Ø£Ù… Ø§Ù„Ù…Ø³Ø§ÙƒÙŠÙ† Ù…Ù† Ø²ÙˆØ¬Ø§Øª Ø§Ù„Ù†Ø¨ÙŠØŸ", g: "Ø®Ø¯ÙŠØ¬Ø©", y: "Ø²ÙŠÙ†Ø¨ Ø¨Ù†Øª Ø®Ø²ÙŠÙ…Ø©", r: "Ø¹Ø§Ø¦Ø´Ø©", c: "yellow" },
            // Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¨Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø­ØªÙ‰ ØªØµÙ„ Ù„Ù€ 100 Ø£Ùˆ Ø£ÙƒØ«Ø±...
            { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ù…ÙˆÙƒÙ„ Ø¨Ø§Ù„ÙˆØ­ÙŠØŸ", g: "Ø¥Ø³Ø±Ø§ÙÙŠÙ„", y: "Ø¬Ø¨Ø±ÙŠÙ„", r: "Ù…ÙŠÙƒØ§Ø¦ÙŠÙ„", c: "yellow" }
        ];

        let gameQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let isScanning = false;
        let holdTimer = 0;
        let lastColor = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ø®ØªÙŠØ§Ø± 45 Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        function initGame() {
            // Ø®Ù„Ø· Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            let shuffled = masterBank.sort(() => 0.5 - Math.random());
            // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ 45 (Ø£Ùˆ Ø§Ù„Ù…ØªØ§Ø­ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„)
            gameQuestions = shuffled.slice(0, 45);
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            
            startCamera();
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                loadQuestion();
                requestAnimationFrame(loop);
            } catch (err) { alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨Ø©"); }
        }

        function loadQuestion() {
            if (currentIdx >= gameQuestions.length) {
                finish(); return;
            }
            resetUI();
            const q = gameQuestions[currentIdx];
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('text-green').innerText = q.g;
            document.getElementById('text-yellow').innerText = q.y;
            document.getElementById('text-red').innerText = q.r;
            document.getElementById('q-counter').innerText = `Ø³Ø¤Ø§Ù„: ${currentIdx + 1} / ${gameQuestions.length}`;
            isScanning = true;
        }

        function loop() {
            if (isScanning && video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = 40; canvas.height = 40; // ØªØµØºÙŠØ± Ù„Ù„Ø³Ø±Ø¹Ø©
                ctx.drawImage(video, video.videoWidth/2-20, video.videoHeight/2-20, 40, 40, 0, 0, 40, 40);
                const data = ctx.getImageData(0,0,40,40).data;
                const color = analyze(data);

                if (color) {
                    if (color === lastColor) {
                        holdTimer++;
                        highlight(color);
                        if (holdTimer > 25) { submit(color); holdTimer = 0; }
                    } else { lastColor = color; holdTimer = 0; }
                } else { clearHigh(); }
            }
            requestAnimationFrame(loop);
        }

        function analyze(data) {
            let r=0, g=0, b=0;
            for(let i=0; i<data.length; i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
            r/=1600; g/=1600; b/=1600; // 40x40

            // ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø­Ø³Ø§Ø³ÙŠØ©
            if (g > r*1.2 && g > b*1.2) return "green";
            if (r > g*1.5 && g > b*1.5) return "yellow";
            if (r > g*1.8 && r > b*1.8) return "red";
            return null;
        }

        function submit(col) {
            isScanning = false;
            const correct = gameQuestions[currentIdx].c;
            const icon = document.getElementById(`res-${col}`);
            
            if (col === correct) {
                icon.innerText = "âœ…"; score++;
                document.getElementById('score-display').innerText = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
            } else {
                icon.innerText = "âŒ";
                document.getElementById(`res-${correct}`).innerText = "ğŸ‘ˆ";
            }

            setTimeout(() => { currentIdx++; loadQuestion(); }, 1500);
        }

        function highlight(c) {
            clearHigh();
            document.getElementById(`card-${c}`).classList.add('selected');
        }

        function clearHigh() {
            document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
        }

        function resetUI() {
            document.querySelectorAll('.res-icon').forEach(el => el.innerText = '');
            clearHigh();
        }

        function finish() {
            document.getElementById('question-area').innerHTML = `
                <div style="text-align:center; padding-top:50px">
                    <h2 style="color:#f1c40f">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
                    <p style="font-size:1.5rem">Ù†ØªÙŠØ¬ØªÙƒ: ${score} Ù…Ù† ${gameQuestions.length}</p>
                    <button id="start-btn" onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
                </div>
            `;
        }
    </script>
</body>
</html>