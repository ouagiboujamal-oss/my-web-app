<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ØµØ¨Ø­Øª Ù†Ø­ÙŠÙØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª */
        #game-container {
            width: 90%;
            max-width: 380px; /* Ø¹Ø±Ø¶ ØµØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¬ÙˆØ§Ù„ */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        /* --- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ --- */
        .camera-wrapper {
            position: relative;
            width: 100%;
            height: 50%; /* ØªØ£Ø®Ø° Ù†ØµÙ Ø§Ù„Ø´Ø§Ø´Ø© */
            overflow: hidden;
            background: #000;
            border-bottom: 2px solid #333;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.6; /* ØªÙ‚Ù„ÙŠÙ„ Ø³Ø·ÙˆØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ØªØ±ÙƒÙŠØ² */
        }

        /* Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
        .scanner-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;  /* ØªØµØºÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ */
            height: 60px;
            border: 2px solid #fff;
            border-radius: 8px;
            z-index: 10;
            box-shadow: 0 0 0 100vh rgba(0, 0, 0, 0.85); /* Ø¸Ù„Ø§Ù… Ø¯Ø§Ù…Ø³ Ø­ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
        }
        
        .scanner-box::after {
            content: '+';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.8);
            font-size: 20px;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© --- */
        #question-area {
            width: 100%;
            height: 50%;
            padding: 15px;
            box-sizing: border-box;
            background: #121212;
            display: flex;
            flex-direction: column;
            justify-content: start;
        }

        .question-text {
            font-size: 1.1rem; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            font-weight: bold;
            margin-bottom: 15px;
            color: #fff;
            text-align: right;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
        }

        .option {
            background: #222;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            transition: 0.2s;
            border: 1px solid #333;
            font-size: 0.9rem;
        }

        /* Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¬ÙˆØ§Ø¨ */
        .color-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-left: 10px;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ù‚Ø§Ø· */
        .dot-green { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .dot-yellow { background-color: #ffff00; box-shadow: 0 0 5px #ffff00; }
        .dot-red { background-color: #ff0000; box-shadow: 0 0 5px #ff0000; }

        /* Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© */
        .option.selected {
            background: #333;
            border-color: #fff;
            transform: scale(1.02);
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-badge {
            margin-right: auto; /* Ø¯ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„ÙŠØ³Ø§Ø± */
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø¡ */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #start-btn {
            background: #f1c40f;
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:#f1c40f; font-size:1.5rem;">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ</h1>
        <p style="color:#ccc; font-size:0.9rem;">Ø¶Ø¹ Ø§Ù„Ù„ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©</p>
        <button id="start-btn" onclick="startCamera()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="game-container" style="display: none;">
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-box"></div>
        </div>

        <div id="question-area">
            <div class="question-text" id="q-text">...</div>
            
            <div class="options">
                <div class="option" id="card-green">
                    <div class="color-dot dot-green"></div>
                    <span id="text-green">...</span>
                    <span class="result-badge" id="res-green"></span>
                </div>

                <div class="option" id="card-yellow">
                    <div class="color-dot dot-yellow"></div>
                    <span id="text-yellow">...</span>
                    <span class="result-badge" id="res-yellow"></span>
                </div>

                <div class="option" id="card-red">
                    <div class="color-dot dot-red"></div>
                    <span id="text-red">...</span>
                    <span class="result-badge" id="res-red"></span>
                </div>
            </div>
            
            <p style="text-align:center; font-size:0.8rem; color:#555; margin-top:10px;">
                Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span>
            </p>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
        const questions = [
            { q: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø¨Ø³Ù…Ù„Ø©ØŸ", green: "ÙŠÙˆÙ†Ø³", yellow: "Ø§Ù„ØªÙˆØ¨Ø©", red: "Ø§Ù„Ù†Ù…Ù„", correct: "yellow" },
            { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", green: "Ø®Ù…Ø³Ø©", yellow: "Ø³ØªØ©", red: "Ø«Ù„Ø§Ø«Ø©", correct: "green" },
            { q: "Ù…Ù† Ù‡Ùˆ Ø£ÙˆÙ„ Ù…Ø¤Ø°Ù† ÙÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", green: "Ø²ÙŠØ¯ Ø¨Ù† Ø«Ø§Ø¨Øª", yellow: "Ø¨Ù„Ø§Ù„ Ø¨Ù† Ø±Ø¨Ø§Ø­", red: "Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨", correct: "yellow" },
            { q: "Ø£Ø·ÙˆÙ„ Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", green: "Ø§Ù„Ø¨Ù‚Ø±Ø©", yellow: "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", red: "Ø§Ù„Ù†Ø³Ø§Ø¡", correct: "green" },
            { q: "ÙÙŠ Ø£ÙŠ Ù…Ø¯ÙŠÙ†Ø© ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙŠ ï·ºØŸ", green: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", yellow: "Ø§Ù„Ø·Ø§Ø¦Ù", red: "Ù…ÙƒØ©", correct: "red" }
        ];

        let currentQIndex = 0;
        let score = 0;
        let isScanning = false;
        let holdTimer = 0;
        let lastDetected = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        async function startCamera() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                loadQuestion();
                requestAnimationFrame(scanColors);
            } catch (err) {
                alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
            }
        }

        function loadQuestion() {
            if (currentQIndex >= questions.length) {
                document.getElementById('question-area').innerHTML = `<h3 style='text-align:center'>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©!<br>Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}</h3><button onclick='location.reload()' style='width:100%; padding:10px;'>Ø¥Ø¹Ø§Ø¯Ø©</button>`;
                return;
            }
            resetCards();
            const q = questions[currentQIndex];
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('text-green').innerText = q.green;
            document.getElementById('text-yellow').innerText = q.yellow;
            document.getElementById('text-red').innerText = q.red;
            isScanning = true;
        }

        function scanColors() {
            if (!isScanning) {
                requestAnimationFrame(scanColors);
                return;
            }

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Ø£Ø®Ø° Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹
                const frameData = ctx.getImageData(canvas.width/2 - 10, canvas.height/2 - 10, 20, 20);
                const color = detectColorHSL(frameData.data);

                if (color) {
                    processSelection(color);
                } else {
                    holdTimer = 0;
                    lastDetected = null;
                    clearHighlights();
                }
            }
            requestAnimationFrame(scanColors);
        }

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© HSL Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©)
        function detectColorHSL(data) {
            let r=0, g=0, b=0, count=0;
            for(let i=0; i<data.length; i+=4) {
                r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++;
            }
            r/=count; g/=count; b/=count;

            // ØªØ­ÙˆÙŠÙ„ RGB Ø¥Ù„Ù‰ HSL
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max == min) { h = s = 0; } 
            else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h *= 60;
            }

            // ØªØµÙÙŠØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ø³ÙˆØ¯Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¶Ø§Ø¡
            if (s < 0.25 || l < 0.15 || l > 0.9) return null;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø© (Hue)
            // Ø§Ù„Ø£Ø­Ù…Ø±: Ù‚Ø±ÙŠØ¨ Ù…Ù† 0 Ø£Ùˆ 360
            if (h >= 330 || h <= 30) return "red";
            // Ø§Ù„Ø£ØµÙØ±: Ø­ÙˆÙ„ 50-60
            if (h >= 35 && h <= 85) return "yellow";
            // Ø§Ù„Ø£Ø®Ø¶Ø±: Ø­ÙˆÙ„ 120
            if (h >= 90 && h <= 170) return "green";

            return null;
        }

        function processSelection(color) {
            if (color === lastDetected) {
                holdTimer++;
                highlightCard(color);
                // Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø­ÙˆØ§Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©)
                if (holdTimer > 25) {
                    submitAnswer(color);
                }
            } else {
                holdTimer = 0;
                lastDetected = color;
                clearHighlights();
            }
        }

        function highlightCard(color) {
            clearHighlights();
            const card = document.getElementById(`card-${color}`);
            if(card) {
                card.classList.add('selected');
                card.style.borderColor = color === 'green' ? '#0f0' : (color === 'red' ? '#f00' : '#ff0');
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.option').forEach(el => {
                el.classList.remove('selected');
                el.style.borderColor = "#333";
            });
        }

        function submitAnswer(userColor) {
            isScanning = false;
            const correctColor = questions[currentQIndex].correct;
            const resBadge = document.getElementById(`res-${userColor}`);
            
            resBadge.style.display = "inline";
            
            if (userColor === correctColor) {
                resBadge.innerText = "âœ…";
                score++;
                document.getElementById('score').innerText = score;
            } else {
                resBadge.innerText = "âŒ";
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
                document.getElementById(`res-${correctColor}`).innerText = "ğŸ‘ˆ";
            }

            setTimeout(() => {
                currentQIndex++;
                loadQuestion();
            }, 1500);
        }

        function resetCards() {
            document.querySelectorAll('.result-badge').forEach(el => el.innerText = '');
            clearHighlights();
        }
    </script>
</body>
</html>