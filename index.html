<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            width: 100%;
            padding: 15px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.5rem; }
        
        #game-container {
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            position: relative;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-wrapper {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            border: 5px solid #333;
            background: #000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        video {
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* Ù‚Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù„Ù…Ø±Ø§ÙŠØ§ */
            display: block;
        }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© */
        .scanner-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            z-index: 10;
            pointer-events: none;
        }
        .scanner-label {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
        #question-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .question-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .options {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            flex-wrap: wrap;
        }
        .option {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 80px;
        }
        .opt-green { background-color: #28a745; }
        .opt-yellow { background-color: #ffc107; color: #000; }
        .opt-red { background-color: #dc3545; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© */
        #status-bar {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1rem;
            height: 30px;
        }
        #score-board {
            margin-top: 10px;
            font-size: 1rem;
            color: #555;
        }

        /* Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ */
        #start-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20%;
        }
        
        /* canvas Ù…Ø®ÙÙŠ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© */
        canvas { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ¨Ø±Ù‰ ğŸ•Œ</h1>
    </header>

    <div id="start-screen">
        <p style="padding: 20px;">
            Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø±ÙØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„ÙˆÙ†Ø© Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§!<br>
            ğŸŸ© Ø§Ù„Ø£Ø®Ø¶Ø± = Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„<br>
            ğŸŸ¨ Ø§Ù„Ø£ØµÙØ± = Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ<br>
            ğŸŸ¥ Ø§Ù„Ø£Ø­Ù…Ø± = Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«
        </p>
        <button id="start-btn" onclick="startCamera()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
    </div>

    <div id="game-container" style="display: none;">
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-box">
                <div class="scanner-label">Ø¶Ø¹ Ø§Ù„Ù„ÙˆÙ† Ù‡Ù†Ø§</div>
            </div>
        </div>
        
        <div id="status-bar">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„ÙˆÙ†...</div>

        <div id="question-card">
            <div class="question-text" id="q-text">Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
            <div class="options">
                <div class="option opt-green" id="opt-1">Ø¥Ø¬Ø§Ø¨Ø© 1</div>
                <div class="option opt-yellow" id="opt-2">Ø¥Ø¬Ø§Ø¨Ø© 2</div>
                <div class="option opt-red" id="opt-3">Ø¥Ø¬Ø§Ø¨Ø© 3</div>
            </div>
        </div>

        <div id="score-board">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score">0</span> / <span id="total">0</span></div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­ØªÙ‰ 45 Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§) ---
        const questions = [
            { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", a: "5 Ø£Ø±ÙƒØ§Ù† (Ø£Ø®Ø¶Ø±)", b: "6 Ø£Ø±ÙƒØ§Ù† (Ø£ØµÙØ±)", c: "3 Ø£Ø±ÙƒØ§Ù† (Ø£Ø­Ù…Ø±)", correct: "green" },
            { q: "Ù…Ù† Ù‡Ùˆ Ø£ÙˆÙ„ Ø§Ù„Ø®Ù„ÙØ§Ø¡ Ø§Ù„Ø±Ø§Ø´Ø¯ÙŠÙ†ØŸ", a: "Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨", b: "Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚", c: "Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù†", correct: "yellow" },
            { q: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ¹Ø¯Ù„ Ø«Ù„Ø« Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", a: "Ø§Ù„ÙÙ„Ù‚", b: "Ø§Ù„Ù†Ø§Ø³", c: "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", correct: "red" },
            { q: "ÙÙŠ Ø£ÙŠ Ø¹Ø§Ù… ÙƒØ§Ù†Øª Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©ØŸ", a: "622 Ù…ÙŠÙ„Ø§Ø¯ÙŠ", b: "610 Ù…ÙŠÙ„Ø§Ø¯ÙŠ", c: "632 Ù…ÙŠÙ„Ø§Ø¯ÙŠ", correct: "green" },
            { q: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªÙŠ Ù„ÙŠØ³ ÙÙŠÙ‡Ø§ Ø±ÙƒÙˆØ¹ ÙˆÙ„Ø§ Ø³Ø¬ÙˆØ¯ØŸ", a: "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ÙŠØ¯", b: "ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ù†Ø§Ø²Ø©", c: "ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰", correct: "yellow" }
            // ... ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø³Ø·Ø± ÙˆÙ„ØµÙ‚Ù‡ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ 40 Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© ...
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let isProcessing = false;
        let holdTimer = 0;
        let lastColor = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status-bar');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                });
                video.srcObject = stream;
                loadQuestion();
                requestAnimationFrame(processFrame);
            } catch (err) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¹Ø¨!");
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }
            const q = questions[currentQuestionIndex];
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('opt-1').innerText = q.a;
            document.getElementById('opt-2').innerText = q.b;
            document.getElementById('opt-3').innerText = q.c;
            document.getElementById('total').innerText = questions.length;
            document.getElementById('score').innerText = score;
            
            statusEl.innerText = "Ø§Ø±ÙØ¹ Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©...";
            statusEl.style.color = "#333";
            isProcessing = true;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        function processFrame() {
            if (!isProcessing) {
                requestAnimationFrame(processFrame);
                return;
            }

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Ø£Ø®Ø° Ø¹ÙŠÙ†Ø© Ù…Ù† ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙˆÙ‡Ù…ÙŠ)
                const frameData = ctx.getImageData(canvas.width/2 - 50, canvas.height/2 - 50, 100, 100);
                const detectedColor = detectDominantColor(frameData.data);

                if (detectedColor) {
                    handleColorDetection(detectedColor);
                } else {
                    holdTimer = 0;
                    statusEl.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„ÙˆÙ† ÙˆØ§Ø¶Ø­...";
                    statusEl.style.color = "#555";
                }
            }
            requestAnimationFrame(processFrame);
        }

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ†
        function detectDominantColor(data) {
            let rTotal = 0, gTotal = 0, bTotal = 0;
            let count = 0;

            for (let i = 0; i < data.length; i += 4) {
                rTotal += data[i];
                gTotal += data[i + 1];
                bTotal += data[i + 2];
                count++;
            }

            const r = rTotal / count;
            const g = gTotal / count;
            const b = bTotal / count;

            // ØªØ­ÙˆÙŠÙ„ RGB Ø¥Ù„Ù‰ HSL Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            // Hue values: Red ~0/360, Green ~120, Yellow ~60
            const hsl = rgbToHsl(r, g, b);
            const h = hsl[0] * 360;
            const s = hsl[1];
            const l = hsl[2];

            // Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù„ÙˆØ§Ù† (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©)
            if (s > 0.3 && l > 0.2 && l < 0.85) { // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ´Ø¨Ø¹ ÙˆØ¥Ø¶Ø§Ø¡Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                if (h >= 340 || h <= 20) return "red";    // Ø£Ø­Ù…Ø±
                if (h >= 70 && h <= 160) return "green";  // Ø£Ø®Ø¶Ø±
                if (h >= 35 && h <= 65) return "yellow";  // Ø£ØµÙØ±
            }
            return null;
        }

        function handleColorDetection(color) {
            let colorNameAr = color === "green" ? "Ø£Ø®Ø¶Ø±" : (color === "yellow" ? "Ø£ØµÙØ±" : "Ø£Ø­Ù…Ø±");
            
            if (color === lastColor) {
                holdTimer++;
                statusEl.innerText = `ØªÙ… Ø±ØµØ¯ ${colorNameAr}.. Ø«Ø¨Ù‘Øª ÙŠØ¯Ùƒ (${Math.ceil((60 - holdTimer)/30)})`;
                statusEl.style.color = color;
                
                // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù…Ø¯Ø© ÙƒØ§ÙÙŠØ© (Ø­ÙˆØ§Ù„ÙŠ 1.5 Ø«Ø§Ù†ÙŠØ©)
                if (holdTimer > 40) {
                    checkAnswer(color);
                    holdTimer = 0;
                    lastColor = null;
                }
            } else {
                holdTimer = 0;
                lastColor = color;
            }
        }

        function checkAnswer(userColor) {
            isProcessing = false;
            const currentQ = questions[currentQuestionIndex];
            
            if (userColor === currentQ.correct) {
                statusEl.innerText = "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!";
                score++;
                playSound('correct');
            } else {
                statusEl.innerText = "âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!";
                playSound('wrong');
            }

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 2000);
        }

        function endGame() {
            document.getElementById('game-container').innerHTML = `
                <div style="padding:40px;">
                    <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
                    <p>Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score} Ù…Ù† ${questions.length}</p>
                    <button id="start-btn" onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>
            `;
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª Ø¹Ø¨Ø± API Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ù„Ø§Ø­Ù‚Ø§Ù‹
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;
            if (max == min) { h = s = 0; } else {
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }

        function playSound(type) {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ØµÙˆØ§Øª Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        }
    </script>
</body>
</html>