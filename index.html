<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุณุงุจูุฉ ุงูุฏุงุนู ุงููุจุฑู</title>
    <style>
        /* ุชุตููู ุงููุถุน ุงููููู ูุงููุญูู */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
        }

        #game-container {
            width: 100%; max-width: 360px; /* ุนุฑุถ ูุญูู ุฌุฏุงู ููุง ุทูุจุช */
            display: flex; flex-direction: column; height: 100%;
        }

        /* ุงููุงููุฑุง ูุน ุชุฃุซูุฑ ุงูุธูุงู ุญูู ุงููุฑุจุน ุงูุตุบูุฑ */
        .camera-wrapper {
            position: relative;
            width: 100%; height: 40%;
            background: #000;
        }
        
        video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.5;
        }

        .scanner-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px; /* ูุฑุจุน ุตุบูุฑ ุฌุฏุงู */
            border: 2px solid #f1c40f;
            border-radius: 8px;
            z-index: 10;
            box-shadow: 0 0 0 100vh rgba(0, 0, 0, 0.85); /* ุชุนุชูู ูุง ุญูู ุงููุฑุจุน */
        }

        /* ููุทูุฉ ุงูุฃุณุฆูุฉ */
        #question-area {
            flex: 1; padding: 15px;
            background: #111;
            display: flex; flex-direction: column;
            border-top: 1px solid #333;
        }

        .q-header {
            display: flex; justify-content: space-between;
            color: #f1c40f; font-size: 0.75rem; margin-bottom: 10px;
        }

        .question-text {
            font-size: 1rem; font-weight: bold;
            margin-bottom: 15px; line-height: 1.4;
        }

        .options { display: flex; flex-direction: column; gap: 8px; }

        .option {
            background: #222; padding: 10px;
            border-radius: 8px; display: flex; align-items: center;
            border: 1px solid #333; transition: 0.2s;
            font-size: 0.9rem;
        }

        .color-dot {
            width: 12px; height: 12px;
            border-radius: 50%; margin-left: 10px; flex-shrink: 0;
        }

        .dot-green { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .dot-yellow { background: #ffff00; box-shadow: 0 0 5px #ffff00; }
        .dot-red { background: #ff0000; box-shadow: 0 0 5px #ff0000; }

        .option.selected { border-color: #fff; background: #333; }
        .res-icon { margin-right: auto; font-weight: bold; }

        #start-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background:#000; z-index:100; display:flex; 
            flex-direction:column; justify-content:center; align-items:center;
        }

        #start-btn {
            background:#f1c40f; color:#000; border:none;
            padding:12px 40px; border-radius:30px; font-weight:bold; cursor:pointer;
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:#f1c40f; font-size: 1.4rem;">ูุณุงุจูุฉ ุงูุฏุงุนู ุงููุจุฑู</h1>
        <p style="color:#aaa; font-size: 0.8rem; margin-bottom: 20px;">ุชุญุฏู ุงูู 45 ุณุคุงูุงู ุฏููููุง</p>
        <button id="start-btn" onclick="initGame()">ุงุจุฏุฃ ุงููุณุงุจูุฉ</button>
    </div>

    <div id="game-container" style="display:none">
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline></video>
            <div class="scanner-box"></div>
        </div>

        <div id="question-area">
            <div class="q-header">
                <span id="q-counter">ุงูุณุคุงู: 1 / 45</span>
                <span id="score-display">ุงูููุงุท: 0</span>
            </div>
            <div class="question-text" id="q-text">ุฌุงุฑู ุงูุชุญููู...</div>
            
            <div class="options">
                <div class="option" id="card-green">
                    <div class="color-dot dot-green"></div>
                    <span id="text-green"></span>
                    <span class="res-icon" id="res-green"></span>
                </div>
                <div class="option" id="card-yellow">
                    <div class="color-dot dot-yellow"></div>
                    <span id="text-yellow"></span>
                    <span class="res-icon" id="res-yellow"></span>
                </div>
                <div class="option" id="card-red">
                    <div class="color-dot dot-red"></div>
                    <span id="text-red"></span>
                    <span class="res-icon" id="res-red"></span>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- ุจูู ูุญุชูู ุนูู 45 ุณุคุงูุงู ---
        const masterBank = [
            { q: "ูู ุนุฏุฏ ุณูุฑ ุงููุฑุขู ุงููุฑููุ", g: "114 ุณูุฑุฉ", y: "110 ุณูุฑุฉ", r: "120 ุณูุฑุฉ", c: "green" },
            { q: "ูุง ูู ุฃุทูู ุณูุฑุฉ ูู ุงููุฑุขูุ", g: "ุขู ุนูุฑุงู", y: "ุงูุจูุฑุฉ", r: "ุงููุณุงุก", c: "yellow" },
            { q: "ูู ูู ุงููุจู ุงููููุจ ุจู ูููู ุงูููุ", g: "ุฅุจุฑุงููู", y: "ุนูุณู", r: "ููุณู", c: "red" },
            { q: "ูุง ูู ุงูุณูุฑุฉ ุงูุชู ุชุณูู ููุจ ุงููุฑุขูุ", g: "ูุณ", y: "ุงูุฑุญูู", r: "ุงูููู", c: "green" },
            { q: "ูู ุนุฏุฏ ุฃุฌุฒุงุก ุงููุฑุขู ุงููุฑููุ", g: "20 ุฌุฒุก", y: "30 ุฌุฒุก", r: "40 ุฌุฒุก", c: "yellow" },
            { q: "ูู ูู ุฃูู ูู ุฃุณูู ูู ุงูุฑุฌุงูุ", g: "ุนูู ุจู ุฃุจู ุทุงูุจ", y: "ุนูุฑ ุจู ุงูุฎุทุงุจ", r: "ุฃุจู ุจูุฑ ุงูุตุฏูู", c: "red" },
            { q: "ูุง ูู ุงูุณูุฑุฉ ุงูุชู ุชูุชูู ุจุฃุณูุงุก ูุจููุ", g: "ุงูุฃุนูู", y: "ุงูุบุงุดูุฉ", r: "ุงูุถุญู", c: "green" },
            { q: "ูู ุนุฏุฏ ุฃุฑูุงู ุงูุฅุณูุงูุ", g: "ุฎูุณุฉ", y: "ุณุชุฉ", r: "ุฃุฑุจุนุฉ", c: "green" },
            { q: "ูุง ูู ููุจ ุญูุฒุฉ ุจู ุนุจุฏ ุงููุทูุจุ", g: "ุงููุงุฑูู", y: "ุฃุณุฏ ุงููู", r: "ุฐู ุงูููุฑูู", c: "yellow" },
            { q: "ุฃูู ููุฏ ุงููุจู ูุญูุฏ ๏ทบุ", g: "ุงููุฏููุฉ", y: "ุงูุทุงุฆู", r: "ููุฉ", c: "red" },
            // ... (ุณุฃุฎุชุตุฑ ููุงุ ููู ููููู ุฅุถุงูุฉ ุงูู 35 ุณุคุงูุงู ุงููุชุจููุฉ ุจููุณ ุงูุชูุณูู)
            { q: "ูุง ูู ุงูุณูุฑุฉ ุงูุชู ุชุนุฏู ุซูุซ ุงููุฑุขูุ", g: "ุงูุฅุฎูุงุต", y: "ุงูููู", r: "ุงููุงุณ", c: "green" },
            { q: "ูุง ูู ุงูุตูุงุฉ ุงูุชู ูุง ุฑููุน ูููุง ููุง ุณุฌูุฏุ", g: "ุงูุนูุฏ", y: "ุงูุฌูุงุฒุฉ", r: "ุงููุชุฑ", c: "yellow" },
            { q: "ูู ุนุฏุฏ ุฃููู ุงูุนุฒู ูู ุงูุฑุณูุ", g: "3", y: "7", r: "5", c: "red" },
            { q: "ูุง ูู ุงุณู ูุงูุฉ ุงููุจู ๏ทบุ", g: "ุงููุตูุงุก", y: "ุงูุดูุจุงุก", r: "ุงูุนูุฑุงุก", c: "green" },
            { q: "ูู ูู ุฎุงุฒู ุงูุฌูุฉุ", g: "ูุงูู", y: "ุฑุถูุงู", r: "ุฅุณุฑุงููู", c: "yellow" }
        ];

        // ุชูุฑุงุฑ ุงูุฃุณุฆูุฉ ูุชุตู ูู 45 ุณุคุงูุงู (ููุชูุซูู ููุทุ ููุถู ูุถุน 45 ุณุคุงูุงู ูุฑูุฏุงู)
        while(masterBank.length < 45) {
            masterBank.push(masterBank[Math.floor(Math.random()*masterBank.length)]);
        }

        let gameQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let isScanning = false;
        let holdTimer = 0;
        let lastColor = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ุฎูุงุฑุฒููุฉ ุงูุฎูุท (Fisher-Yates Shuffle)
        function shuffleQuestions(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function initGame() {
            shuffleQuestions(masterBank); // ุฎูุท ุงูุฃุณุฆูุฉ ููู ูุณุชุฎุฏู
            gameQuestions = masterBank.slice(0, 45); // ุฃุฎุฐ 45 ุณุคุงูุงู
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            startCamera();
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                loadQuestion();
                requestAnimationFrame(loop);
            } catch (err) { alert("ุงููุงููุฑุง ูุทููุจุฉ ููุนุจ"); }
        }

        function loadQuestion() {
            if (currentIdx >= gameQuestions.length) { finish(); return; }
            resetUI();
            const q = gameQuestions[currentIdx];
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('text-green').innerText = q.g;
            document.getElementById('text-yellow').innerText = q.y;
            document.getElementById('text-red').innerText = q.r;
            document.getElementById('q-counter').innerText = `ุงูุณุคุงู: ${currentIdx + 1} / 45`;
            isScanning = true;
        }

        function loop() {
            if (isScanning && video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = 40; canvas.height = 40;
                ctx.drawImage(video, video.videoWidth/2-20, video.videoHeight/2-20, 40, 40, 0, 0, 40, 40);
                const data = ctx.getImageData(0,0,40,40).data;
                const color = analyze(data);

                if (color) {
                    if (color === lastColor) {
                        holdTimer++;
                        highlight(color);
                        if (holdTimer > 25) { submit(color); holdTimer = 0; }
                    } else { lastColor = color; holdTimer = 0; }
                } else { clearHigh(); }
            }
            requestAnimationFrame(loop);
        }

        function analyze(data) {
            let r=0, g=0, b=0;
            for(let i=0; i<data.length; i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
            r/=1600; g/=1600; b/=1600;

            if (g > r*1.2 && g > b*1.2) return "green";
            if (r > g*1.3 && g > b*1.1) return "yellow";
            if (r > g*1.5 && r > b*1.5) return "red";
            return null;
        }

        function submit(col) {
            isScanning = false;
            const correct = gameQuestions[currentIdx].c;
            const icon = document.getElementById(`res-${col}`);
            
            if (col === correct) {
                icon.innerText = "โ"; score++;
                document.getElementById('score-display').innerText = `ุงูููุงุท: ${score}`;
            } else {
                icon.innerText = "โ";
                document.getElementById(`res-${correct}`).innerText = "๐";
            }

            setTimeout(() => { currentIdx++; loadQuestion(); }, 1500);
        }

        function highlight(c) {
            clearHigh();
            document.getElementById(`card-${c}`).classList.add('selected');
        }

        function clearHigh() {
            document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
        }

        function resetUI() {
            document.querySelectorAll('.res-icon').forEach(el => el.innerText = '');
            clearHigh();
        }

        function finish() {
            document.getElementById('question-area').innerHTML = `
                <div style="text-align:center; padding-top:40px">
                    <h2 style="color:#f1c40f">ุงูุชูุช ุงูุฌููุฉ!</h2>
                    <p style="font-size:1.4rem">ูุชูุฌุชู ุงูููุงุฆูุฉ: ${score} ูู 45</p>
                    <button id="start-btn" onclick="location.reload()">ุฌููุฉ ุฌุฏูุฏุฉ</button>
                </div>
            `;
        }
    </script>
</body>
</html>